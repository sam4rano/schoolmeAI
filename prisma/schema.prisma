// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum InstitutionType {
  university
  polytechnic
  college
  nursing
  military
}

enum Ownership {
  federal
  state
  private
}

enum ConfidenceLevel {
  verified
  estimated
  unverified
}

enum AdmissionMode {
  UTME
  POST_UTME
  DIRECT_ENTRY
}

model Institution {
  id                  String          @id @default(uuid())
  name                String
  type                InstitutionType
  ownership           Ownership
  state               String
  city                String
  website             String?         @db.Text
  contact             Json? // {email, phone, address}
  accreditationStatus String?
  courses             Json? // Array of program objects
  // tuitionFees         Json? // {schedule: [{program, level, amount, currency, per_year, breakdown}], lastUpdated, source} - Not in DB yet
  // feesSchedule        Json? // Alias for tuitionFees for backward compatibility - Not in DB yet
  provenance          Json? // {source_url, fetched_at, license}
  lastVerifiedAt      DateTime?
  dataQualityScore    Int?            @default(0) @db.SmallInt // 0-100
  missingFields       String[] // Array of missing field names
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  programs            Program[]
  auditEvents         AuditEvent[]
  reviews             Review[]
  questions           Question[]
  userStories         UserStory[]
  watchlistItems      InstitutionWatchlist[]

  @@index([state])
  @@index([type])
  @@index([ownership])
  @@index([type, ownership])
  @@index([state, type])
  @@index([name, type])
  @@index([accreditationStatus])
  @@index([dataQualityScore])
  @@map("institutions")
}

model Program {
  id                        String    @id @default(uuid())
  institutionId             String
  name                      String
  faculty                   String?
  department                String?
  degreeType                String? // BSc, ND, OND, HC, MBBS, etc.
  description               String?   @db.Text // Program description/overview
  duration                  String? // e.g., "4 years", "5 years"
  utmeSubjects              String[] // Array of required UTME subjects
  olevelSubjects            String[] // Array of required O-level subjects
  admissionRequirements     Json? // {jamb_score, olevel_requirements, direct_entry, etc.}
  cutoffHistory             Json? // Array of {year, cutoff, admission_mode, source_url, confidence}
  tuitionFees               Json? // {amount, currency, per_year, breakdown}
  careerProspects           String[] // Array of career opportunities
  courseCurriculum          Json? // Array of courses by year/level
  applicationDeadline       DateTime? // Application deadline
  officialUrl               String?   @db.Text // Link to official program page
  contact                   Json? // {email, phone, department_contact}
  accreditationStatus       String? // Program accreditation status (Full, Interim, Denied, Unknown)
  accreditationMaturityDate  Int? // Year when accreditation expires (e.g., 2024, 2026, 2028)
  accreditationLastUpdated  DateTime? // When accreditation data was last updated
  isActive                  Boolean   @default(true) // Whether program is still offered
  lastVerifiedAt            DateTime?
  dataQualityScore          Int?      @default(0) @db.SmallInt
  missingFields             String[] // Array of missing field names
  provenance                Json? // {source_url, fetched_at, license}
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt

  institution    Institution             @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  watchlistItems ApplicationsWatchlist[]
  calculations   Calculation[]
  auditEvents    AuditEvent[]
  reviews        Review[]
  questions      Question[]
  answers        Answer[]
  userStories    UserStory[]

  @@index([institutionId])
  @@index([institutionId, name])
  @@index([institutionId, degreeType])
  @@index([name, degreeType])
  @@index([name])
  @@index([degreeType])
  @@map("programs")
}

model User {
  id             String    @id @default(uuid())
  email          String    @unique
  emailVerified  DateTime?
  hashedPassword String?
  roles          String[]  @default(["user"])
  status         String    @default("active") // active, suspended, banned, pending_verification
  profile        Json? // {name, dob, state_of_origin, catchment_preferences}
  lastLoginAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  oLevels              OLevel[]
  watchlistItems       ApplicationsWatchlist[]
  institutionWatchlist InstitutionWatchlist[]
  calculations         Calculation[]
  auditEvents    AuditEvent[]
  sessions       Session[]
  accounts       Account[]
  reviews        Review[]
  notifications  Notification[]
  forumPosts     ForumPost[]
  forumComments  ForumComment[]
  questions      Question[]
  answers        Answer[]
  userStories    UserStory[]
  News           News[]

  @@index([emailVerified])
  @@index([status])
  @@map("users")
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  userAgent    String? // Browser/device info
  ipAddress    String? // IP address
  deviceInfo   String? // Device type, OS, etc.
  createdAt    DateTime @default(now())
  lastActiveAt DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expires])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  type       String   @default("email") // email, password_reset
  used       Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@unique([identifier, token])
  @@index([identifier, type])
  @@index([expires])
  @@map("verification_tokens")
}

model OLevel {
  id              String   @id @default(uuid())
  userId          String
  examBody        String // WAEC, NECO, GCE, etc.
  year            Int
  grades          Json // {subject: grade} e.g., {"maths": "A1", "english": "B2"}
  computedPoints  Float?
  computedSummary String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("o_levels")
}

model ApplicationsWatchlist {
  id         String    @id @default(uuid())
  userId     String
  programId  String
  priority   String? // high, medium, low
  notes      String?   @db.Text // User notes/annotations
  notifiedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([userId, programId])
  @@index([userId])
  @@index([programId])
  @@map("applications_watchlist")
}

model InstitutionWatchlist {
  id         String    @id @default(uuid())
  userId     String
  institutionId String
  priority   String? // high, medium, low
  notes      String?   @db.Text // User notes/annotations
  notifiedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  @@unique([userId, institutionId])
  @@index([userId])
  @@index([institutionId])
  @@map("institution_watchlist")
}

model Calculation {
  id             String   @id @default(uuid())
  userId         String
  programId      String
  utme           Int      @db.SmallInt // UTME score (0-400)
  olevels        Json // {subject: grade} e.g., {"maths": "A1", "english": "B2"}
  compositeScore Float // Calculated composite score
  probability    Float? // Admission probability (0-1)
  category       String // safe, target, reach
  rationale      String?  @db.Text // Explanation of the calculation
  result         Json // Full eligibility result
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([programId])
  @@index([createdAt])
  @@map("calculations")
}

model AuditEvent {
  id            String   @id @default(uuid())
  entityType    String // institution, program, user, etc.
  entityId      String
  action        String // create, update, delete, read
  metadata      Json? // Additional context
  userId        String?
  institutionId String?
  programId     String?
  createdAt     DateTime @default(now())

  user        User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  institution Institution? @relation(fields: [institutionId], references: [id], onDelete: SetNull)
  program     Program?     @relation(fields: [programId], references: [id], onDelete: SetNull)

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_events")
}

model Embedding {
  id          String                      @id @default(uuid())
  entityType  String                      @map("entity_type") // institution, program, faq, policy
  entityId    String                      @map("entity_id")
  content     String                      @db.Text // Original text content
  contentHash String                      @map("content_hash") // Hash of content for deduplication
  embedding   Unsupported("vector(1536)") // OpenAI ada-002 embedding dimension
  metadata    Json? // Additional metadata (source, title, etc.)
  createdAt   DateTime                    @default(now()) @map("created_at")
  updatedAt   DateTime                    @updatedAt @map("updated_at")

  @@unique([entityType, entityId, contentHash])
  @@index([entityType, entityId])
  @@map("embeddings")
}

enum ReviewStatus {
  pending
  approved
  rejected
  flagged
}

model Review {
  id              String       @id @default(uuid())
  userId          String
  entityType      String // "institution" or "program"
  entityId        String // institutionId or programId
  institutionId   String?
  programId       String?
  rating          Int // 1-5 stars
  title           String? // Review title
  content         String       @db.Text // Review content
  status          ReviewStatus @default(pending) // Moderation status
  helpfulCount    Int          @default(0) // Number of helpful votes
  reportedCount   Int          @default(0) // Number of reports
  moderationNotes String?      @db.Text // Admin notes
  moderatedBy     String? // Admin user ID who moderated
  moderatedAt     DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  institution Institution? @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  program     Program?     @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([userId, entityType, entityId]) // One review per user per entity
  @@index([entityType, entityId])
  @@index([entityType, entityId, status])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([institutionId])
  @@index([programId])
  @@map("reviews")
}

enum NotificationType {
  deadline_reminder
  watchlist_update
  new_program
  cutoff_update
  fee_update
  general
}

enum NotificationStatus {
  unread
  read
  archived
}

model Notification {
  id        String             @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String             @db.Text
  status    NotificationStatus @default(unread)
  link      String? // URL to related page
  metadata  Json? // Additional data (programId, institutionId, etc.)
  readAt    DateTime?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, status])
  @@index([userId, status, type])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("notifications")
}

// Community Features Models

enum PostStatus {
  draft
  published
  archived
  deleted
}

enum QuestionStatus {
  open
  answered
  closed
  resolved
}

model ForumCategory {
  id          String   @id @default(uuid())
  name        String
  description String?  @db.Text
  slug        String   @unique
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  posts ForumPost[]

  @@index([slug])
  @@index([order])
  @@map("forum_categories")
}

model ForumPost {
  id          String     @id @default(uuid())
  userId      String
  categoryId  String
  title       String
  content     String     @db.Text
  status      PostStatus @default(published)
  views       Int        @default(0)
  likes       Int        @default(0)
  replies     Int        @default(0)
  isPinned    Boolean    @default(false)
  isLocked    Boolean    @default(false)
  lastReplyAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  user     User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  category ForumCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  comments ForumComment[]

  @@index([categoryId])
  @@index([userId])
  @@index([status])
  @@index([isPinned, createdAt])
  @@index([createdAt])
  @@map("forum_posts")
}

model ForumComment {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  content   String   @db.Text
  parentId  String? // For nested replies
  likes     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  post    ForumPost      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent  ForumComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies ForumComment[] @relation("CommentReplies")

  @@index([postId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
  @@map("forum_comments")
}

model Question {
  id            String         @id @default(uuid())
  userId        String
  title         String
  content       String         @db.Text
  status        QuestionStatus @default(open)
  views         Int            @default(0)
  upvotes       Int            @default(0)
  tags          String[] // Array of tags
  institutionId String?
  programId     String?
  bestAnswerId  String?        @unique
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  institution Institution? @relation(fields: [institutionId], references: [id], onDelete: SetNull)
  program     Program?     @relation(fields: [programId], references: [id], onDelete: SetNull)
  answers     Answer[]
  bestAnswer  Answer?      @relation("BestAnswer", fields: [bestAnswerId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([institutionId])
  @@index([programId])
  @@index([createdAt])
  @@index([upvotes])
  @@map("questions")
}

model Answer {
  id         String   @id @default(uuid())
  questionId String
  userId     String
  content    String   @db.Text
  upvotes    Int      @default(0)
  isAccepted Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  question       Question  @relation(fields: [questionId], references: [id], onDelete: Cascade)
  questionAsBest Question? @relation("BestAnswer")
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  Program        Program?  @relation(fields: [programId], references: [id])
  programId      String?

  @@index([questionId])
  @@index([userId])
  @@index([isAccepted])
  @@index([upvotes])
  @@index([createdAt])
  @@map("answers")
}

model UserStory {
  id            String       @id @default(uuid())
  userId        String
  title         String
  content       String       @db.Text
  institutionId String?
  programId     String?
  utmeScore     Int?
  admissionYear Int?
  status        ReviewStatus @default(pending) // Reuse ReviewStatus for moderation
  featured      Boolean      @default(false)
  views         Int          @default(0)
  likes         Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  institution Institution? @relation(fields: [institutionId], references: [id], onDelete: SetNull)
  program     Program?     @relation(fields: [programId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([featured])
  @@index([institutionId])
  @@index([programId])
  @@index([createdAt])
  @@map("user_stories")
}

model Settings {
  id                        String   @id @default("system") // Single record
  // Data Quality Settings
  autoCalculateQualityScore Boolean  @default(true)
  qualityScoreThreshold     Int      @default(70) @db.SmallInt // 0-100
  // Audit Settings
  enableAuditLogging        Boolean  @default(true)
  auditLogRetentionDays     Int      @default(365) @db.SmallInt // 30-3650
  // API Settings
  enablePublicAPI           Boolean  @default(false)
  apiRateLimit              Int      @default(100) @db.SmallInt // 10-10000
  // Notification Settings
  notifyOnDataQualityIssues Boolean  @default(true)
  notifyOnBulkOperations    Boolean  @default(true)
  // Metadata
  updatedBy                 String? // Admin user ID who last updated
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@map("settings")
}

enum NewsCategory {
  jamb
  post_utme
  nursing_schools
  admission
  nysc
  general
  scholarships
  cutoff_updates
  accreditation
}

enum NewsStatus {
  draft
  published
  archived
}

model News {
  id          String       @id @default(uuid())
  title       String
  slug        String       @unique
  excerpt     String?      @db.Text // Short summary
  content     String       @db.Text // Full article content
  category    NewsCategory
  status      NewsStatus   @default(published)
  featured    Boolean      @default(false)
  imageUrl    String?      @db.Text // Featured image URL
  authorId    String? // Admin user ID who created the news
  sourceUrl   String?      @db.Text // Original source URL if scraped
  tags        String[] // Array of tags for filtering
  views       Int          @default(0)
  publishedAt DateTime? // When news was published
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  author User? @relation(fields: [authorId], references: [id], onDelete: SetNull)

  @@index([category])
  @@index([status])
  @@index([featured])
  @@index([publishedAt])
  @@index([createdAt])
  @@index([category, status])
  @@index([slug])
  @@map("news")
}
