// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum InstitutionType {
  university
  polytechnic
  college
  nursing
  military
}

enum Ownership {
  federal
  state
  private
}

enum ConfidenceLevel {
  verified
  estimated
  unverified
}

enum AdmissionMode {
  UTME
  POST_UTME
  DIRECT_ENTRY
}

model Institution {
  id                  String          @id @default(uuid())
  name                String
  type                InstitutionType
  ownership           Ownership
  state               String
  city                String
  website             String?         @db.Text
  contact             Json? // {email, phone, address}
  accreditationStatus String?
  courses             Json? // Array of program objects
  tuitionFees         Json? // {schedule: [{program, level, amount, currency, per_year, breakdown}], lastUpdated, source}
  feesSchedule        Json? // Alias for tuitionFees for backward compatibility
  provenance          Json? // {source_url, fetched_at, license}
  lastVerifiedAt      DateTime?
  dataQualityScore    Int?            @default(0) @db.SmallInt // 0-100
  missingFields       String[] // Array of missing field names
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  programs    Program[]
  auditEvents AuditEvent[]
  reviews     Review[]

  @@index([state])
  @@index([type])
  @@index([ownership])
  @@index([type, ownership])
  @@index([state, type])
  @@index([name, type])
  @@map("institutions")
}

model Program {
  id                    String    @id @default(uuid())
  institutionId         String
  name                  String
  faculty               String?
  department            String?
  degreeType            String? // BSc, ND, OND, HC, MBBS, etc.
  description           String?   @db.Text // Program description/overview
  duration              String? // e.g., "4 years", "5 years"
  utmeSubjects          String[] // Array of required UTME subjects
  olevelSubjects        String[] // Array of required O-level subjects
  admissionRequirements Json? // {jamb_score, olevel_requirements, direct_entry, etc.}
  cutoffHistory         Json? // Array of {year, cutoff, admission_mode, source_url, confidence}
  tuitionFees           Json? // {amount, currency, per_year, breakdown}
  careerProspects       String[] // Array of career opportunities
  courseCurriculum      Json? // Array of courses by year/level
  applicationDeadline   DateTime? // Application deadline
  officialUrl           String?   @db.Text // Link to official program page
  contact               Json? // {email, phone, department_contact}
  accreditationStatus   String? // Program accreditation status
  lastVerifiedAt        DateTime?
  dataQualityScore      Int?      @default(0) @db.SmallInt
  missingFields         String[] // Array of missing field names
  provenance            Json? // {source_url, fetched_at, license}
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  institution    Institution             @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  watchlistItems ApplicationsWatchlist[]
  auditEvents    AuditEvent[]
  reviews        Review[]

  @@index([institutionId])
  @@index([institutionId, name])
  @@index([institutionId, degreeType])
  @@index([name, degreeType])
  @@index([name])
  @@index([degreeType])
  @@map("programs")
}

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  hashedPassword String?
  roles          String[] @default(["user"])
  profile        Json? // {name, dob, state_of_origin, catchment_preferences}
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  oLevels        OLevel[]
  watchlistItems ApplicationsWatchlist[]
  auditEvents    AuditEvent[]
  sessions       Session[]
  accounts       Account[]
  reviews        Review[]
  notifications  Notification[]

  @@map("users")
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model OLevel {
  id              String   @id @default(uuid())
  userId          String
  examBody        String // WAEC, NECO, GCE, etc.
  year            Int
  grades          Json // {subject: grade} e.g., {"maths": "A1", "english": "B2"}
  computedPoints  Float?
  computedSummary String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("o_levels")
}

model ApplicationsWatchlist {
  id         String    @id @default(uuid())
  userId     String
  programId  String
  priority   String? // high, medium, low
  notifiedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([userId, programId])
  @@index([userId])
  @@index([programId])
  @@map("applications_watchlist")
}

model AuditEvent {
  id            String   @id @default(uuid())
  entityType    String // institution, program, user, etc.
  entityId      String
  action        String // create, update, delete, read
  metadata      Json? // Additional context
  userId        String?
  institutionId String?
  programId     String?
  createdAt     DateTime @default(now())

  user        User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  institution Institution? @relation(fields: [institutionId], references: [id], onDelete: SetNull)
  program     Program?     @relation(fields: [programId], references: [id], onDelete: SetNull)

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_events")
}

model Embedding {
  id          String                      @id @default(uuid())
  entityType  String                      @map("entity_type") // institution, program, faq, policy
  entityId    String                      @map("entity_id")
  content     String                      @db.Text // Original text content
  contentHash String                      @map("content_hash") // Hash of content for deduplication
  embedding   Unsupported("vector(1536)") // OpenAI ada-002 embedding dimension
  metadata    Json? // Additional metadata (source, title, etc.)
  createdAt   DateTime                    @default(now()) @map("created_at")
  updatedAt   DateTime                    @updatedAt @map("updated_at")

  @@unique([entityType, entityId, contentHash])
  @@index([entityType, entityId])
  @@map("embeddings")
}

enum ReviewStatus {
  pending
  approved
  rejected
  flagged
}

model Review {
  id              String       @id @default(uuid())
  userId          String
  entityType      String // "institution" or "program"
  entityId        String // institutionId or programId
  institutionId   String?
  programId       String?
  rating          Int // 1-5 stars
  title           String? // Review title
  content         String       @db.Text // Review content
  status          ReviewStatus @default(pending) // Moderation status
  helpfulCount    Int          @default(0) // Number of helpful votes
  reportedCount   Int          @default(0) // Number of reports
  moderationNotes String?      @db.Text // Admin notes
  moderatedBy     String? // Admin user ID who moderated
  moderatedAt     DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  institution Institution? @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  program     Program?     @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([userId, entityType, entityId]) // One review per user per entity
  @@index([entityType, entityId])
  @@index([entityType, entityId, status])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([institutionId])
  @@index([programId])
  @@map("reviews")
}

enum NotificationType {
  deadline_reminder
  watchlist_update
  new_program
  cutoff_update
  fee_update
  general
}

enum NotificationStatus {
  unread
  read
  archived
}

model Notification {
  id        String             @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String             @db.Text
  status    NotificationStatus @default(unread)
  link      String? // URL to related page
  metadata  Json? // Additional data (programId, institutionId, etc.)
  readAt    DateTime?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, status])
  @@index([userId, status, type])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("notifications")
}
